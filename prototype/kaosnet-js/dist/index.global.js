"use strict";var KaosNet=(()=>{var p=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var b=(c,e)=>{for(var t in e)p(c,t,{get:e[t],enumerable:!0})},f=(c,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of k(e))!S.call(c,s)&&s!==t&&p(c,s,{get:()=>e[s],enumerable:!(n=w(e,s))||n.enumerable});return c};var y=c=>f(p({},"__esModule",{value:!0}),c);var T={};b(T,{Client:()=>l,KaosClient:()=>l,KaosSocket:()=>u,OpCode:()=>g,Socket:()=>u});var g=(o=>(o[o.SessionStart=1]="SessionStart",o[o.SessionEnd=2]="SessionEnd",o[o.Heartbeat=3]="Heartbeat",o[o.SessionAck=4]="SessionAck",o[o.RoomCreate=16]="RoomCreate",o[o.RoomJoin=17]="RoomJoin",o[o.RoomLeave=18]="RoomLeave",o[o.RoomData=19]="RoomData",o[o.RoomState=20]="RoomState",o[o.RoomList=21]="RoomList",o[o.Rpc=32]="Rpc",o[o.RpcResponse=33]="RpcResponse",o[o.MatchmakerAdd=48]="MatchmakerAdd",o[o.MatchmakerRemove=49]="MatchmakerRemove",o[o.MatchmakerMatched=50]="MatchmakerMatched",o[o.Error=255]="Error",o))(g||{}),R={enablePrediction:!1,enableInterpolation:!0,interpolationBuffer:100},u=class{constructor(e,t,n){this.ws=null;this.session=null;this.reconnectAttempts=0;this.reconnectTimer=null;this.heartbeatTimer=null;this.rpcCallbacks=new Map;this.rpcIdCounter=0;this.currentMatchId=null;this.eventListeners=new Map;this._state="disconnected";this.wsUrl=e,this.clientOptions=t,this.socketOptions={...R,...n}}get state(){return this._state}get isConnected(){return this._state==="connected"&&this.ws?.readyState===WebSocket.OPEN}log(...e){this.clientOptions.verbose&&console.log("[KaosSocket]",...e)}emit(e,...t){let n=this.eventListeners.get(e);if(n)for(let s of n)try{s(...t)}catch(r){console.error(`Error in ${e} listener:`,r)}switch(e){case"connect":this.onConnect?.();break;case"disconnect":this.onDisconnect?.(t[0]);break;case"error":this.onError?.(t[0]);break;case"matchmakerMatched":this.onMatchmakerMatched?.(t[0]);break;case"matchPresenceJoin":this.onMatchPresenceJoin?.(t[0],t[1]);break;case"matchPresenceLeave":this.onMatchPresenceLeave?.(t[0],t[1]);break;case"matchState":this.onMatchState?.(t[0]);break}}on(e,t){return this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(t),()=>this.off(e,t)}off(e,t){this.eventListeners.get(e)?.delete(t)}once(e,t){let n=((...s)=>{this.off(e,n),t(...s)});return this.on(e,n)}async connect(e){if(this._state==="connected"||this._state==="connecting")throw new Error("Already connected or connecting");return this.session=e,this._state="connecting",new Promise((t,n)=>{let s=`${this.wsUrl}?token=${encodeURIComponent(e.token)}`;this.log("Connecting to",this.wsUrl);try{this.ws=new WebSocket(s),this.ws.binaryType="arraybuffer"}catch(i){this._state="disconnected",n(i);return}let r=setTimeout(()=>{this.ws?.close(),this._state="disconnected",n(new Error("Connection timeout"))},this.clientOptions.timeout);this.ws.onopen=()=>{clearTimeout(r),this._state="connected",this.reconnectAttempts=0,this.startHeartbeat(),this.log("Connected"),this.emit("connect"),t()},this.ws.onerror=i=>{clearTimeout(r);let a=new Error("WebSocket error");this.log("Error:",a),this.emit("error",a),this._state==="connecting"&&n(a)},this.ws.onclose=i=>{clearTimeout(r),this.stopHeartbeat();let a=this._state==="connected",h=this._state==="connecting";this._state="disconnected",this.log("Disconnected:",i.reason||"Connection closed"),this.emit("disconnect",i.reason),a&&this.clientOptions.autoReconnect&&this.attemptReconnect(),h&&n(new Error(i.reason||"Connection failed"))},this.ws.onmessage=i=>{this.handleMessage(i.data)}})}disconnect(){this.clientOptions.autoReconnect=!1,this.clearReconnectTimer(),this.stopHeartbeat(),this.ws?.close(1e3,"Client disconnect"),this.ws=null,this._state="disconnected"}attemptReconnect(){if(this.reconnectAttempts>=this.clientOptions.maxReconnectAttempts){this.log("Max reconnect attempts reached");return}this._state="reconnecting",this.reconnectAttempts++;let e=this.clientOptions.reconnectDelay*Math.pow(2,this.reconnectAttempts-1);this.log(`Reconnecting in ${e}ms (attempt ${this.reconnectAttempts})`),this.emit("reconnect",this.reconnectAttempts),this.reconnectTimer=setTimeout(async()=>{if(this.session)try{await this.connect(this.session)}catch{}},e)}clearReconnectTimer(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}startHeartbeat(){this.heartbeatTimer=setInterval(()=>{this.sendOpcode(3)},3e4)}stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)}sendOpcode(e,t){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("Not connected");let n=t?.length??0,s=new ArrayBuffer(4+n),r=new DataView(s);r.setUint8(0,e),r.setUint8(1,0),r.setUint16(2,n,!0),t&&new Uint8Array(s,4).set(t),this.ws.send(s)}sendJson(e,t){let n=JSON.stringify(t),r=new TextEncoder().encode(n);this.sendOpcode(e,r)}handleMessage(e){if(typeof e=="string"){try{let i=JSON.parse(e);this.handleJsonMessage(i)}catch(i){this.log("Failed to parse JSON message:",i)}return}let t=new DataView(e);if(e.byteLength<4){this.log("Invalid message: too short");return}let n=t.getUint8(0),s=t.getUint16(2,!0);if(e.byteLength<4+s){this.log("Invalid message: payload truncated");return}let r=new Uint8Array(e,4,s);this.handleBinaryMessage(n,r)}handleJsonMessage(e){this.emit("matchState",{opcode:0,data:e,sender:void 0})}handleBinaryMessage(e,t){let n=new TextDecoder;switch(e){case 4:this.log("Session acknowledged");break;case 3:break;case 20:if(this.currentMatchId)try{let s=JSON.parse(n.decode(t));this.emit("matchState",{opcode:s.opcode??0,data:s.data??s,sender:s.sender})}catch{this.emit("matchState",{opcode:0,data:t,sender:void 0})}break;case 33:{let r=new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0,!0),i=n.decode(t.slice(4)),a=this.rpcCallbacks.get(r);if(a){this.rpcCallbacks.delete(r);try{a.resolve(JSON.parse(i))}catch{a.resolve(i)}}break}case 50:{try{let s=JSON.parse(n.decode(t));this.emit("matchmakerMatched",s)}catch(s){this.log("Failed to parse matchmaker match:",s)}break}case 255:{let s=n.decode(t);this.log("Server error:",s),this.emit("error",new Error(s));break}default:this.log("Unknown opcode:",e)}}async addMatchmaker(e){return this.rpc("matchmaker.add",e)}async removeMatchmaker(e){await this.rpc("matchmaker.remove",{ticket_id:e})}async createMatch(e){let t=await this.rpc("match.create",{name:e});return this.currentMatchId=t.matchId,t}async joinMatch(e,t){let n=await this.rpc("match.join",{match_id:e,metadata:t});return this.currentMatchId=e,n}async leaveMatch(){this.currentMatchId&&(await this.rpc("match.leave",{match_id:this.currentMatchId}),this.currentMatchId=null)}sendMatchState(e,t,n){if(!this.currentMatchId)throw new Error("Not in a match");this.sendJson(19,{match_id:this.currentMatchId,opcode:e,data:t,presences:n?.map(s=>s.sessionId)})}send(e){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)throw new Error("Not connected");this.ws.send(JSON.stringify(e))}async rpc(e,t){return new Promise((n,s)=>{let r=++this.rpcIdCounter;this.rpcCallbacks.set(r,{resolve:n,reject:s});let i=new TextEncoder,a=i.encode(e),h=t?i.encode(JSON.stringify(t)):new Uint8Array(0),d=new Uint8Array(5+a.length+h.length);new DataView(d.buffer).setUint32(0,r,!0),d[4]=a.length,d.set(a,5),d.set(h,5+a.length);try{this.sendOpcode(32,d)}catch(v){this.rpcCallbacks.delete(r),s(v)}setTimeout(()=>{this.rpcCallbacks.has(r)&&(this.rpcCallbacks.delete(r),s(new Error(`RPC timeout: ${e}`)))},this.clientOptions.timeout)})}};var m={host:"localhost",port:7350,useSSL:!1,timeout:1e4,autoReconnect:!0,maxReconnectAttempts:5,reconnectDelay:1e3,verbose:!1},l=class{constructor(e,t,n){typeof e=="object"?this.options={...m,...e}:this.options={...m,host:e??m.host,port:t??m.port,useSSL:n??m.useSSL};let s=this.options.useSSL?"https":"http";this.baseUrl=`${s}://${this.options.host}:${this.options.port}`}log(...e){this.options.verbose&&console.log("[KaosClient]",...e)}async request(e,t,n,s){let r=`${this.baseUrl}${t}`,i={"Content-Type":"application/json"};s&&(i.Authorization=`Bearer ${s.token}`),this.log(`${e} ${t}`);let a=await fetch(r,{method:e,headers:i,body:n?JSON.stringify(n):void 0,signal:AbortSignal.timeout(this.options.timeout)});if(!a.ok){let h=await a.json().catch(()=>({error:a.statusText}));throw new Error(h.error||h.message||`HTTP ${a.status}`)}return a.json()}async authenticateDevice(e,t,n){let s=typeof e=="string"?{deviceId:e,create:t,username:n}:e;return(await this.request("POST","/api/auth/device",{device_id:s.deviceId,create:s.create??!0,username:s.username})).session}async authenticateEmail(e,t,n,s){let r=typeof e=="string"?{email:e,password:t,create:n,username:s}:e;return(await this.request("POST","/api/auth/email",{email:r.email,password:r.password,create:r.create??!0,username:r.username})).session}async authenticateCustom(e,t,n,s){let r=typeof e=="string"?{id:e,create:t,username:n,vars:s}:e;return(await this.request("POST","/api/auth/custom",{id:r.id,create:r.create??!0,username:r.username,vars:r.vars})).session}async refreshSession(e){if(!e.refreshToken)throw new Error("Session does not have a refresh token");return(await this.request("POST","/api/auth/refresh",{refresh_token:e.refreshToken})).session}isSessionExpired(e){return Date.now()/1e3>=e.expiresAt}createSocket(){let t=`${this.options.useSSL?"wss":"ws"}://${this.options.host}:${this.options.port+1}`;return new u(t,this.options)}async readStorageObjects(e,t){return(await this.request("POST","/api/storage/read",{object_ids:t.map(s=>({collection:s.collection,key:s.key,user_id:s.userId}))},e)).objects}async writeStorageObjects(e,t){return(await this.request("POST","/api/storage/write",{objects:t.map(s=>({collection:s.collection,key:s.key,value:s.value,version:s.version,permission_read:s.permissionRead,permission_write:s.permissionWrite}))},e)).objects}async deleteStorageObjects(e,t){await this.request("POST","/api/storage/delete",{object_ids:t.map(n=>({collection:n.collection,key:n.key,version:n.version}))},e)}async listStorageObjects(e,t,n,s,r){let i=new URLSearchParams({collection:t});return n&&i.set("user_id",n),s&&i.set("limit",String(s)),r&&i.set("cursor",r),this.request("GET",`/api/storage?${i}`,void 0,e)}async listLeaderboardRecords(e,t,n,s,r){let i=new URLSearchParams;return n?.length&&i.set("owner_ids",n.join(",")),s&&i.set("limit",String(s)),r&&i.set("cursor",r),this.request("GET",`/api/leaderboards/${t}/records?${i}`,void 0,e)}async writeLeaderboardRecord(e,t,n,s,r){await this.request("POST",`/api/leaderboards/${t}/records`,{score:n,subscore:s,metadata:r},e)}async addMatchmaker(e,t){return this.request("POST","/api/matchmaker/add",{queue:t.queue,query:t.query,min_count:t.minCount??2,max_count:t.maxCount??8,string_properties:t.stringProperties??{},numeric_properties:t.numericProperties??{}},e)}async removeMatchmaker(e){return this.request("DELETE","/api/matchmaker/remove",void 0,e)}async getMatchmakerTicket(e,t){let n=t??e.userId;try{return await this.request("GET",`/api/matchmaker/tickets/${n}`,void 0,e)}catch{return null}}async listMatchmakerQueues(e){return this.request("GET","/api/matchmaker/queues",void 0,e)}async rpc(e,t,n){return(await this.request("POST",`/api/rpc/${t}`,{payload:n},e)).payload}};return y(T);})();
